{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"computeApiVersion": {"type": "string"},
		"networkApiVersion": {"type": "string"},
		"storageApiVersion": {"type": "string"},
		"clusterName": {"type": "string"},
		"clusterNameClean": {"type": "string"},
		"clusterVNETName": {"type": "string"},
		
		"nodesSACount": {"type": "int"},
		"nodesPerGroupCount": {"type": "int"},
		"nodesStorageAccountprefix": {"type": "string" },
		

		"sshKeyPath": {"type": "string"},
		"sshKeyData": {"type": "string"},
		"adminUsername": {"type": "string"},
		"nodesVMSku": {"type": "string"},
		"coreOSType": {"type": "string"},
		
		"nodeGroupIndex" : {"type": "int"},
		"nodeIndex" : {"type": "int"},

		"nodesGroupAvSetName" : {"type" : "string"},
		"nodesSubNetName" : {"type" : "string"}
	},
	"variables": {
		"CoreOs-Stable": {
			"publisher": "CoreOs",
			"offer": "CoreOs",
			"sku": "Stable",
			"version": "latest"
		},
		"CoreOs-Beta": {
			"publisher": "CoreOS",
			"offer": "CoreOs",
			"sku": "beta",
			"version": "latest"
		},
		 "imageReference": "[variables(parameters('coreOSType'))]",
		 "nodeSeq" : "[concat( parameters('nodeGroupIndex') , '-', parameters('nodeIndex') )]",
		 "nodeTargetSAPostfix" : "[mod( parameters('nodeIndex') , parameters('nodesSACount') )]",
		 "nodeName" : "[concat('node-',  variables('nodeSeq'))]",
		 "nodeIp" : "[concat('11.', add(parameters('nodeGroupIndex'), 1), '.', add(parameters('nodeIndex'), 1)  ,'.0')]",
		 "nodeRoutePrefix" : "[concat('11.', add(parameters('nodeGroupIndex'), 3) , '.', add(parameters('nodeIndex'), 2), '.0', '/24')]"
	},
	"resources": [
		{
			"comments" : "create a new nic for this node",
			"type": "Microsoft.Network/networkInterfaces",
			"name": "[concat('node-nic-', variables('nodeSeq'))]",
			"apiVersion": "[parameters('networkApiVersion')]",
			"location": "[resourceGroup().location]",
			"dependsOn": [],
			"properties": {
				"enableIPForwarding": true,
				"ipConfigurations": [
					{
						"name": "node-ip-config",
						"properties": {
							"privateIPAllocationMethod": "Static",
							"privateIPAddress": "[variables('nodeIp')]",
							"subnet": {
								"id": "[ concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', parameters('clusterVNETName'), '/subnets/', parameters('nodesSubNetName') )  ]"
							},
							"loadBalancerBackendAddressPools": []
						}
					}
				]
			}
		},
		{
			"comments": "Cluster node vm",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[variables('nodeName')]",
			"apiVersion": "[parameters('computeApiVersion')]",
			"location": "[resourceGroup().location]",
			"dependsOn": ["[concat('Microsoft.Network/networkInterfaces/' , 'node-nic-', variables('nodeSeq') )]"],
			"properties": {
				"availabilitySet": { 
						"id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Compute/availabilitySets/', parameters('nodesGroupAvSetName')  )]"
						},
				"hardwareProfile": {"vmSize": "[parameters('nodesVMSku')]"},
				"osProfile": {
					"computerName": "[concat('node-', variables('nodeSeq'))]",
					"adminUsername": "[parameters('adminUsername')]",
					"linuxConfiguration": {
						"disablePasswordAuthentication": "true",
						"ssh": {
							"publicKeys": [
								{
									"path": "[parameters('sshKeyPath')]",
									"keyData": "[parameters('sshKeyData')]"
								}
							]
						}
					}
				},
				"storageProfile": {
					"imageReference": "[variables('imageReference')]",
					"osDisk": {
						"name": "osdisk",
						"vhd": {
							"uri": "[concat('https://',  parameters('nodesStorageAccountprefix'), variables('nodeTargetSAPostfix'), '.blob.core.windows.net/', variables('nodeSeq') , '/', 'node-OsDisk.vhd')]"
						},
						"caching": "ReadWrite",
						"createOption": "FromImage"
					}
				},
				"networkProfile": {
					"networkInterfaces": [ 
							{
							"id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/networkInterfaces/', concat('node-nic-', variables('nodeSeq')) )]"
							}
						]
				}
			}
		},
		{
			"comments" : "add new route to the new cluster node",
			"type": "Microsoft.Network/routeTables/routes",
			"apiVersion": "[parameters('networkApiVersion')]",
			"name": "[concat( parameters('VNETRoutingTableName'),'/', 'route-', variables('nodeSeq'))]",
			"location": "[resourceGroup().location]",
		    "dependsOn": ["[concat('Microsoft.Compute/virtualMachines/' ,  variables('nodeName') )]"],
			"properties": {
				"addressPrefix": "[variables('nodeRoutePrefix')]",
				"nextHopType": "VirtualAppliance",
				"nextHopIpAddress": "[variables('nodeIp')]"
				}
   		}
	]
}