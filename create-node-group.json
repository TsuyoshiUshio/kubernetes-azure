{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"computeApiVersion": {"type": "string"},
		"networkApiVersion": {"type": "string"},
		"storageApiVersion": {"type": "string"},
		"resourceApiVersion": {"type" : "string"},

		"clusterName": {"type": "string"},
		"clusterNameClean": {"type": "string"},
		"clusterVNETName": {"type": "string"},
		
		"nodesSACount": {"type": "int"},
		"nodesPerGroupCount": {"type": "int"},
		"nodesStorageAccountprefix": {"type": "string" },
		

		"baseTemplatesUri" : {"type": "string" },
		 "templateCreateNode" : {"type": "string" },

		"sshKeyPath": {"type": "string"},
		"sshKeyData": {"type": "string"},
		"adminUsername": {"type": "string"},
		"nodesVMSku": {"type": "string"},
		"coreOSType": {"type": "string"},
		
		"nodeGroupIndex" : {"type": "int"}
	},
	"variables": {
		"nodesGroupAvSetName": "[concat('nodes-avset-',parameters('nodeGroupIndex'))]",
		"subnetName" : "[concat('net-node-group-',  parameters('nodeGroupIndex'))]"

	},
	"resources": [
		{
			"comments" : "create subnet for the new node",
			"apiVersion": "[parameters('networkApiVersion')]",
			"type": "Microsoft.Network/virtualNetworks/subnets",
			"name": "[concat(parameters('clusterVNETName'), '/', variables('subnetName') )]",
			"dependsOn": [],
			"location": "[resourceGroup().location]",
			"properties": {"addressPrefix": "[concat('10.', add(parameters('nodeGroupIndex'), 3) , '.0.0', '/16')]"}
		},
		{
			"comments": "Node Availability Set",
			"type": "Microsoft.Compute/availabilitySets",
			"name": "[variables('nodesGroupAvSetName')]",
			"apiVersion": "[parameters('computeApiVersion')]",
			"location": "[resourceGroup().location]",
			"properties": {
				"platformFaultDomainCount": "3",
				"platformUpdateDomainCount": "5"
			}
		},
			{
			"comments": "Creates nodes",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[parameters('resourceApiVersion')]",
			"name": "[concat('create-node-', parameters('nodeGroupIndex') ,'-',copyIndex())]",
			"copy": {
				"name": "nodeLoop",
				"count": "[parameters('nodesPerGroupCount')]"
			},
			"dependsOn": [
				"[concat('Microsoft.Compute/availabilitySets/', variables('nodesGroupAvSetName'))]"
			],
			"properties": {
				"mode": "incremental",
				"templateLink": {
					"uri": "[concat(parameters('baseTemplatesUri'), parameters('templateCreateNode'))]",
					"contentVersion": "1.0.0.0"
				},
				"parameters": {
					"computeApiVersion": {"value": "[parameters('computeApiVersion')]"},
					"networkApiVersion": {"value": "[parameters('networkApiVersion')]"},
					"storageApiVersion": {"value": "[parameters('storageApiVersion')]"},
					"clusterName": {"value": "[parameters('clusterName')]"},
					"clusterNameClean": {"value": "[parameters('clusterNameClean')]"},
					"clusterVNETName": {"value": "[parameters('clusterVNETName')]"},
					"nodesStorageAccountprefix": {"value": "[parameters('nodesStorageAccountprefix')]"},

					"nodesPerGroupCount": {"value": "[parameters('nodesPerGroupCount')]"},
					"nodeGroupIndex" : {"value": "[parameters('nodeGroupIndex')]"},
				    "nodesSACount":  {"value": "[parameters('nodesSACount')]"},
					"nodeIndex" : {"value" : "[copyIndex()]"},
	
					"sshKeyPath": {"value": "[parameters('sshKeyPath')]"},
					"sshKeyData": {"value": "[parameters('sshKeyData')]"},
					"adminUsername": {"value": "[parameters('adminUsername')]"},
					"nodesVMSku": {"value": "[parameters('nodesVMSku')]"},
					"coreOSType" : {"value" : "[parameters('coreOSType')]"},
					"nodesGroupAvSetName" : {"value" : "[variables('nodesGroupAvSetName')]"},

					"subnetName" : {"value: ": "[variables('subnetName')]"}
				}
			}
		}
	]
}